<?php namespace Sheba\Business\AttendanceActionLog\ActionChecker;

use Carbon\Carbon;
use Sheba\Business\AttendanceActionLog\WeekendHolidayByBusiness;
use Sheba\Business\Leave\HalfDay\HalfDayLeaveCheck;
use Sheba\Dal\AttendanceActionLog\Actions;

class CheckOut extends ActionChecker
{
    public function getActionName()
    {
        return Actions::CHECKOUT;
    }

    protected function setAlreadyHasActionForTodayResponse()
    {
        $this->setResult(ActionResult::ALREADY_CHECKED_OUT);
    }

    public function check()
    {
        parent::check(); // TODO: Change the autogenerated stub
        $this->checkAlreadyCheckedIn();
        $this->checkLeftEarly();
    }

    private function checkAlreadyCheckedIn()
    {
        if ($this->isAlreadyFailed()) return;
        if (!$this->hasCheckedIn()) $this->setResult(ActionResult::CHECKIN_FIRST);
    }

    private function hasCheckedIn()
    {
        return $this->attendanceLogsOfToday ? $this->attendanceLogsOfToday->filter(function ($log) {
                return $log->action == Actions::CHECKIN;
            })->count() > 0 : false;
    }

    protected function checkLeftEarly()
    {
        $date = Carbon::now();
        $weekendHoliday = new WeekendHolidayByBusiness();

        $which_half_day = (new HalfDayLeaveCheck())->setBusinessMember($this->businessMember)->checkHalfDayLeave();
        $today_last_checkout_time = $this->business->calculationTodayLastCheckOutTime($which_half_day);

        if (is_null($today_last_checkout_time)) return;
        if ($this->isAlreadyFailed()) return;

        $today_checkout_time_without_second = Carbon::parse($date->format('Y-m-d H:i'));
        $is_full_day_leave = (new HalfDayLeaveCheck())->setBusinessMember($this->businessMember)->checkFullDayLeave();

        if ($today_checkout_time_without_second->lessThan(Carbon::parse($today_last_checkout_time))) {
            if ($weekendHoliday->isWeekendByBusiness($date) || $weekendHoliday->isHolidayByBusiness($date) || $is_full_day_leave) {
                $this->setResult(ActionResult::SUCCESSFUL);
            } else {
                $this->setResult(ActionResult::LEFT_EARLY_TODAY);
            }
        }
    }
}
